## ADNL UDP

ADNL over UDP используется нодами и компонентами тона для коммуникации между собой. Это протокол нижнего уровня поверх которого работают другие, более высокоуровневые протоколы TON, такие как DHT и RLDP. В этой статье мы разберем как устроен ADNL over UDP при базовом обмене данными между нодами, тунелирование и анонимизация трафика будет разобрана в отдельной статье.

В отличии от ADNL over TCP, в UDP реализации отстутствует хэндшейк, но другие принципы похожи, ключи так же генерируются на основе нашего приватного ключа и публичного ключа сервера, который известен заранее, из конфига, или получен отдругих узлов сети.

В UDP версии ADNL соединение устанавливается одновременно с получением превых данных от клиента, вычисляется ключ и подтверждается создание канала, если инициатор послал сообщение о желании создать канал. 

В рамках одного соединения может быть открыто несколько каналов, они нужны для изоляции данных, каждый канал имеет свой айди и ключ шифрования. Но обычно, для базового взаимодействия, используется всего один канал, который создается вместе с первым запросом.

### Устройство пакетов и обмен информацией

Весь обмен данными осуществляется с помощью пакетов, контент которого представляет из себя [TL структуру](https://github.com/ton-blockchain/ton/blob/master/tl/generate/scheme/ton_api.tl#L81):
```
adnl.packetContents 
  rand1:bytes                                     -- случайные 7 или 15 байт
  flags:#                                         -- битовые флаги, используется для определения наличия полей далее
  from:flags.0?PublicKey                          -- публичный ключ отправителя
  from_short:flags.1?adnl.id.short                -- айди отправителя
  message:flags.2?adnl.Message                    -- сообщение (используется если оно одно)
  messages:flags.3?(vector adnl.Message)          -- сообщения (если их > 1)
  address:flags.4?adnl.addressList                -- список наших адресов
  priority_address:flags.5?adnl.addressList       -- приоритетный список наших адресов
  seqno:flags.6?long                              -- порядковый номер пакета
  confirm_seqno:flags.7?long                      -- порядковый номер последнего полученного пакета
  recv_addr_list_version:flags.8?int              -- версия адресов 
  recv_priority_addr_list_version:flags.9?int     -- версия приоритетных адресов
  reinit_date:flags.10?int                        -- дата реинициализации соединения (сброса счетчиков)
  dst_reinit_date:flags.10?int                    -- дата реинициализации соединения из последнего полученного пакета
  signature:flags.11?bytes                        -- подпись
  rand2:bytes                                     -- случайные 7 или 15 байт
        = adnl.PacketContents
```
И в качестве префикса к сериализованой структуре контента идет публичный ключ точки назначения (сервера/клиента) - 32 байта, и sha256 хеш сериализованой TL структуры  контента пакета - 32 байта.


