## ADNL UDP

ADNL over UDP используется нодами и компонентами тона для коммуникации между собой. Это протокол нижнего уровня поверх которого работают другие, более высокоуровневые протоколы TON, такие как DHT и RLDP. В этой статье мы разберем как устроен ADNL over UDP при базовом обмене данными между нодами, тунелирование и анонимизация трафика будет разобрана в отдельной статье.

В отличии от ADNL over TCP, в UDP реализации хэндшейк происходит в другом виде, и используется дополнительный слой в виде каналов, но другие принципы похожи, ключи так же генерируются на основе нашего приватного ключа и публичного ключа сервера, который известен заранее, из конфига, или получен отдругих узлов сети.

В UDP версии ADNL соединение устанавливается одновременно с получением превых данных от клиента, вычисляется ключ и подтверждается создание канала, если инициатор послал сообщение о желании создать канал. 

В рамках одного соединения может быть открыто несколько каналов, они нужны для изоляции данных, каждый канал имеет свой айди и ключ шифрования. Но обычно, для базового взаимодействия, используется всего один канал, который создается вместе с первым запросом.

### Устройство пакетов и обмен информацией

##### Разбор примера
Разберем инициализацию соединения с DHT нодой и получения подписанного списка ее адресов, чтобы понять как устроен обмен данными.

Найдем понравившуюся ноду в [конфиге меиннета](https://ton-blockchain.github.io/global.config.json), в разделе `dht.nodes`. Например:
```json
{
  "@type": "dht.node",
  "id": {
    "@type": "pub.ed25519",
    "key": "fZnkoIAxrTd4xeBgVpZFRm5SvVvSx7eN3Vbe8c83YMk="
  },
  "addr_list": {
    "@type": "adnl.addressList",
    "addrs": [
      {
        "@type": "adnl.address.udp",
        "ip": 1091897261,
        "port": 15813
      }
    ],
    "version": 0,
    "reinit_date": 0,
    "priority": 0,
    "expire_at": 0
  },
  "version": -1,
  "signature": "cmaMrV/9wuaHOOyXYjoxBnckJktJqrQZ2i+YaY3ehIyiL3LkW81OQ91vm8zzsx1kwwadGZNzgq4hI4PCB/U5Dw=="
}
```

1. Возьмем ее ключ `fZnkoIAxrTd4xeBgVpZFRm5SvVvSx7eN3Vbe8c83YMk`, декодируем из base64
2. Возьмем ее IP адрес `1091897261` и переведем его в понятный формат используя [сервис](https://www.browserling.com/tools/dec-to-ip), получим `65.21.7.173`
3. Совместим с портом, получим `65.21.7.173:15813` и установим UDP соединение.

Мы хотим открыть канал для постоянного обмена информацией с нодой, и в качестве основной задачи - получить от нее список подписаных адресов. Для этого мы сформируем 2 сообщения, первое - [создать канал](https://github.com/ton-blockchain/ton/blob/master/tl/generate/scheme/ton_api.tl#L129):
```
adnl.message.createChannel key:int256 date:int = adnl.Message
```
Тут у нас 2 параметра, ключ и дата, в качестве даты мы укажем текущий unix таймштамп. А для ключа - нам нужно сгенерировать новую пару приватный/публичный ключ, специально для канала, они будут использоваться для подписи сообщений и инициализации [общего ключа шифрования](/ADNL-TCP-Liteserver.md#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BE%D0%B1%D1%89%D0%B5%D0%B3%D0%BE-%D0%BA%D0%BB%D1%8E%D1%87%D0%B0-%D0%BF%D0%BE-ecdh). В параметр `key` сообщения мы укажим наш сгенерирвоаный публичный ключ, а приватный пока просто запомним.

Сериализуем заполненую TL структуру и получим:
```
bbc373e6                                                         -- TL ID adnl.message.createChannel 
d59d8e3991be20b54dde8b78b3af18b379a62fa30e64af361c75452f6af019d7 -- key
555c8763                                                         -- date
```

Далее перейдем к нашему основному запросу - [получить список адресов](https://github.com/ton-blockchain/ton/blob/master/tl/generate/scheme/ton_api.tl#L198). Чтобы его выполнить, нам надо сначала сериализовать его TL структуру:
```
dht.getSignedAddressList = dht.Node
```
В нем нет параметров, поэтому просто сериализуем его. Получим `ed4879a9`

Далее, так как это запрос более высокого уровня, пртокола DHT, нам нужно сначала обернуть его в `adnl.message.query` TL структуру:
```
adnl.message.query query_id:int256 query:bytes = adnl.Message
```
В качестве `query_id` генерируем случайные 32 байта, в качестве `query` - используем наш основной запрос, [обернутый как массив байтов](/TL.md#кодирование-bytes-в-tl). Получаем:
```
7af98bb4                                                         -- TL ID adnl.message.query
d7be82afbc80516ebca39784b8e2209886a69601251571444514b7f17fcd8875 -- query_id
04 ed4879a9 000000                                               -- query
```
 
###### Собираем пакет

Весь обмен данными осуществляется с помощью пакетов, контент которых представляет из себя [TL структуру](https://github.com/ton-blockchain/ton/blob/master/tl/generate/scheme/ton_api.tl#L81):
```
adnl.packetContents 
  rand1:bytes                                     -- случайные 7 или 15 байт
  flags:#                                         -- битовые флаги, используется для определения наличия полей далее
  from:flags.0?PublicKey                          -- публичный ключ отправителя
  from_short:flags.1?adnl.id.short                -- айди отправителя
  message:flags.2?adnl.Message                    -- сообщение (используется если оно одно)
  messages:flags.3?(vector adnl.Message)          -- сообщения (если их > 1)
  address:flags.4?adnl.addressList                -- список наших адресов
  priority_address:flags.5?adnl.addressList       -- приоритетный список наших адресов
  seqno:flags.6?long                              -- порядковый номер пакета
  confirm_seqno:flags.7?long                      -- порядковый номер последнего полученного пакета
  recv_addr_list_version:flags.8?int              -- версия адресов 
  recv_priority_addr_list_version:flags.9?int     -- версия приоритетных адресов
  reinit_date:flags.10?int                        -- дата реинициализации соединения (сброса счетчиков)
  dst_reinit_date:flags.10?int                    -- дата реинициализации соединения из последнего полученного пакета
  signature:flags.11?bytes                        -- подпись
  rand2:bytes                                     -- случайные 7 или 15 байт
        = adnl.PacketContents
        
```

После того как мы сериализовали все сообщения которые хотим отправить, мы можем приступать к сборке пакета, пакеты для отправки в канал отличаются по содержанию от пакетов которые отправляются до инициализации канала. Сначала разберем основной пакет, который используется для инициализации.

При первоначальном обмене информацией, вне канала, в качестве префикса к сериализованой структуре контента пакета идет публичный ключ сервера - 32 байта, наш публичный ключ - 32 байта, и sha256 хеш сериализованой TL структуры контента пакета - 32 байта. Контент пакета шифруется с помощью [общего ключа](/ADNL-TCP-Liteserver.md#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BE%D0%B1%D1%89%D0%B5%D0%B3%D0%BE-%D0%BA%D0%BB%D1%8E%D1%87%D0%B0-%D0%BF%D0%BE-ecdh), полученного из нашего приватного ключа и публичного ключа сервера.

Сериализуем нашу структуру контента пакета, и разберем побайтово:
```
89cd42d1                                                               -- TL ID adnl.packetContents
0f 4e0e7dd6d0c5646c204573bc47e567                                      -- rand1, 15 (0f) случайных байтов
d90d0000                                                               -- flags (0xdd9) -> 0b110111011001
                                                                       -- from (присутствует т.к 0й бит = 1)
c6b41348                                                                  -- TL ID pub.ed25519
   afc46336dd352049b366c7fd3fc1b143a518f0d02d9faef896cb0155488915d6       -- key:int256
                                                                       -- messages (присутствует т.к 3й бит = 1)
02000000                                                                  -- vector adnl.Message, размер 2 сообщения   
   bbc373e6                                                                  -- TL ID adnl.message.createChannel
   d59d8e3991be20b54dde8b78b3af18b379a62fa30e64af361c75452f6af019d7          -- key
   555c8763                                                                  -- date (дата создания)
   
   7af98bb4                                                                  -- TL ID adnl.message.query
   d7be82afbc80516ebca39784b8e2209886a69601251571444514b7f17fcd8875          -- query_id
   04 ed4879a9 000000                                                        -- query (bytes размер 4, паддинг 3)
                                                                       -- address (присутствует т.к 4й бит = 1), без TL ID т.к указан явно
00000000                                                                  -- addrs (пустой vector, т.к мы в режиме клиента)
555c8763                                                                  -- version (обычно дата инициализации)
555c8763                                                                  -- reinit_date
00000000                                                                  -- priority
00000000                                                                  -- expire_at

02000000                                                               -- seqno

000000000000000000000000555c8763555c87630000000040b453fbcbd8e884586b464290fe07475ee0da9df0b8d191e41e44f8f42a63a710b45eefe8ffdc56de73db50a25989816dda17a4ac6c2f72f49804a97ff41df5020000000f2b6a8c0509f85da9f3c7e11c86ba22

```


TODO




