# DHT

DHT - Расшифровывается как Distributed Hash Table, и по сути представляет из себя распределенную базу данных ключ-значение, 
где каждый участник сети может что то сохранить, например информацию о себе.

Реализация DHT в TON по своей сути похожа на реализацию [Kademlia](https://ru.wikipedia.org/wiki/Kademlia).
Любой участник сети может запустить DHT ноду, сгенерировать ключи, и хранить данные. 
Для этого ему нужно сгенерировать случайный айди, и сообщить о себе другим нодам.

Для определения на какой ноде сохранить данные, используется алгоритм определения "расстояния" между нодой и ключем. 
Алгоритм прост, берем айди ноды и айди ключа, производим операцию XOR, чем меньше получилось значение, тем ближе нода.
Задача в том чтобы сохранить ключ на максимально близким к ключу нодам, чтобы другие участники сети могли используя 
тот же алгоритм найти ноду которая сможет отдать данные по этому ключу.

### Поиск значения по ключу
Разберем пример с поиском ключа, [подключимся к любой DHT ноде и установим соединение по ADNL UDP](/ADNL-UDP-Internal.md#устройство-пакетов-и-обмен-информацией).

Например мы хотим найти адрес и данные для подключения к RLDP ноде ТОН сайта foundation.ton. Допустим мы уже получили ADNL адрес этого сайта, выполнив Get метод DNS контракта. ADNL адресом в hex представлении будет `516618cf6cbe9004f6883e742c9a2e3ca53ed02e3e36f4cef62a98ee1e449174`. Теперь наша задача найти ip, порт и публичный ключ ноды имеющей этот адрес.

Чтобы это сделать, нам нужно получить ID DHT ключа, сначала соберем сам DHT ключ:
```
dht.key id:int256 name:bytes idx:int = dht.Key
```
Заполнив эту схему получим:
```
8fde67f6                                                           -- TL ID dht.key
516618cf6cbe9004f6883e742c9a2e3ca53ed02e3e36f4cef62a98ee1e449174   -- наш искомый ADNL адрес
07 61646472657373                                                  -- тип ключа, слово "address" в виде массива bytes
00000000                                                           -- индекс 0 т.к ключ всего 1
```
Далее - получим айди ключа, это будет sha256 хеш от сериализованых выше байтов. Это будет `b30af0538916421b46df4ce580bf3a29316831e0c3323a7f156df0236c5b2f75`

Теперь мы можем приступить к поиску, для этого нам нужно выполнить запрос имеющий [схему](https://github.com/ton-blockchain/ton/blob/master/tl/generate/scheme/ton_api.tl#L197):
```
dht.findValue key:int256 k:int = dht.ValueResult
```
`key` - это айди нашего DHT ключа, а `k` - это "ширина" поиска, чем она меньше тем точнее, но меньше потенциальных нод для опроса. Максимальное k для нод в тоне равно 10, мы можем использовать 6.

Заполним эту структуру, сериализуем и отправим запрос используя схему `adnl.message.query`. [Подробнее об этом можну узнать в другой статье.](/ADNL-UDP-Internal.md#устройство-пакетов-и-обмен-информацией).

В ответ мы можем получить:
* `dht.valueNotFound` - если значение не найдено. Ответ будет содержать список нод которые известны запрошеной нами ноде и находятся максимально близко запрошеному нами ключу из списка известных ей. В этом случае нам нужно подключиться и добавить полученые ноды к списку известных нам. После этого выбрать самую близкую, доступную и еще не опрошеную, и повторить запрос к ней. И так пока мы не попробуем все ноды в выбраном нами диапозоне.
* `dht.valueFound` - если значение найдено на этой ноде. Ответ будет содержать само значение, подписи, и полную информацию по ключу.
Мы разберем оба случая.
