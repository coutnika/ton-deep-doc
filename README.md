# TON Deep Documentation
Документация по внутреним компонентам ТОНа которая поможет разобраться как все работает.

## ADNL
Это протокол нижнего уровня на котором построено все взаимодействие в сети TON, он может работать поверх любого протокола, но чаще всего применяется поверх TCP и UDP. UDP применяется больше для общения между нодами, а TCP для коммуникации с клиентами.

Вместо адресов, узлы сети используют публичные ключи ed25519 и устанавливают соединение используя общий ключ полученный с помощью процедуры Диффи-Хелмана для эллиптических кривых - ECDH.

#### Структура пакетов
Каждый ADNL пакет, кроме хэндшейка, имеет структуру:
* 4 байта размера пакета (N)
* 32 байта nonce [[?]](a "случайные байты, нужны для защиты от атак на чексумму")
* (N - 64) байт полезных данных
* 32 байта чексумма [[?]](a "SHA256 от nonce + полезных данных")

#### Установка соединения
Клиент генерирует 160 случайных байт которые будут использоваться сторонами для вычисления общих ключей. 
Для установки соединения клиент должен отправить хэндшейк пакет содержащий:
* **Айди ключа сервера** [Подробнее]
* **Свой публичный ключ ed25519** [[?]](a "можно генерировать новую пару на каждое соединение")
* **SHA256 хэш от сгенерированых 160 байт**
* **160 байт зашифрованых общим ECDH ключем** [Подробнее]

Также из этих 160 байт создаются 2 ключа, которые будут использоваться сторонами для AES-CTR шифрования/дешифрования сообщений после хэндшейка, с применением вида:

* ключ A используется стороной X для шифрования отправляемых сообщений.
* ключ A используется стороной Y для дешифрования полученных сообщений.
* ключ B используется стороной Y для шифрования отправляемых сообщений.
* ключ B используется стороной X для дешифрования полученных сообщений.

После успешного хэндшейка, сервер ответит пустым ADNL пакетом, без полезных данных. С этого момента можно считать соединение установленым.



#### Технические детали реализации клиента
